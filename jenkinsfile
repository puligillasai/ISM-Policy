pipeline {
  agent {
    docker {
      image 'williamyeh/ansible:alpine3'   // common Ansible image
      args '-u root:root'
    }
  }
  environment {
    INVENTORY = 'inventory'
    PLAYBOOK = 'playbook.yml'
    TARGET_USER = 'ubuntu'
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Run Ansible') {
      steps {
        sshagent (credentials: ['ansible-ssh-key-id']) {
          sh "ansible-playbook -i ${INVENTORY} ${PLAYBOOK} -u ${TARGET_USER}"
        }
      }
    }

    stage('Verify') {
      steps {
        sshagent (credentials: ['ansible-ssh-key-id']) {
          sh "ssh -o StrictHostKeyChecking=no ${TARGET_USER}@192.0.2.10 \"docker exec -i postgres_demo psql -U demo_user -d demo_db -c \\\"SELECT version();\\\"\""
        }
      }
    }
  }
}
